<!DOCTYPE html>
<html lang="es" class="h-full scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Reserva - Complejo Deportivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@400;700;800&display.swap');
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; }

        .horario-btn.selected {
            background-color: #059669;
            color: white;
            font-weight: 600;
            border-color: #047857;
            transform: scale(1.05);
        }
        
        .dark-input {
            background-color: #1F2937;
            border-color: #374151;
            color: #F9FAFB;
        }
        .dark-input:focus {
            border-color: #059669;
            --tw-ring-color: #059669;
        }
        .dark-input:disabled {
            background-color: #374151;
            color: #6B7280;
            cursor: not-allowed;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .loader {
            border-top-color: #10B981;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 flex flex-col min-h-screen">

    <div class="absolute inset-0 -z-10 overflow-hidden" aria-hidden="true">
        <div class="absolute left-[calc(50%-10rem)] top-20 sm:left-[calc(50%-30rem)] aspect-[1155/678] w-[72.1875rem] -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#059669] to-[#030712] opacity-20 sm:opacity-10" style="clip-path: polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)"></div>
    </div>

    <header class="bg-gray-900 shadow-xl sticky top-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold text-emerald-500">Complejo</span>
                    <span class="text-2xl font-bold text-gray-100">Deportivo</span>
                </a>
                <div>
                     <a href="index.html" class="text-sm font-medium text-emerald-500 hover:text-emerald-400 transition-colors duration-200">
                        &larr; Volver al inicio
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8 flex flex-col justify-center">
        <div class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white uppercase">Reservá tu Turno</h1>
            <p class="mt-3 text-lg text-gray-400">Seleccioná tu complejo, cancha y fecha para ver los horarios.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">

            <div class="lg:col-span-1 bg-gray-900 rounded-xl shadow-2xl border border-gray-800 p-6 h-fit">
                <h3 class="text-2xl font-semibold text-white mb-6">Tus Filtros</h3>
                <div class="space-y-6">
                    <div>
                        <label for="reserva-complejo" class="block text-sm font-medium text-gray-300 mb-1">1. Complejo</label>
                        <select id="reserva-complejo" class="dark-input mt-1 block w-full rounded-md shadow-sm focus:ring focus:ring-emerald-500 focus:ring-opacity-50">
                            <option value="">Cargando complejos...</option>
                        </select>
                    </div>
                    <div>
                        <label for="reserva-fecha" class="block text-sm font-medium text-gray-300 mb-1">2. Fecha</label>
                        <input type="date" id="reserva-fecha" class="dark-input mt-1 block w-full rounded-md shadow-sm focus:ring focus:ring-emerald-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="reserva-cancha" class="block text-sm font-medium text-gray-300 mb-1">3. Cancha</label>
                        <select id="reserva-cancha" class="dark-input mt-1 block w-full rounded-md shadow-sm focus:ring focus:ring-emerald-500 focus:ring-opacity-50" disabled>
                            <option value="">Elegí un complejo primero</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-gray-900 rounded-xl shadow-2xl border border-gray-800 p-6">
                <h3 class="text-2xl font-semibold text-white mb-6">4. Horarios Disponibles</h3>
                
                <div id="horarios-placeholder" class="text-center py-16 text-gray-500">
                    <svg class="h-12 w-12 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                    <p class="mt-4 font-medium">Completá los filtros para ver los turnos.</p>
                </div>

                <div id="reserva-horarios-loader" class="hidden text-center py-16">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-700 h-12 w-12 mx-auto"></div>
                    <p class="mt-4 text-gray-400">Buscando horarios...</p>
                </div>
                
                <div id="reserva-horarios-grid" class="hidden grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 max-h-72 overflow-y-auto p-1">
                    </div>

                <div id="paso-final" class="hidden mt-6">
                    <div id="paso-final-error" class="text-red-500 text-sm hidden mb-4"></div>
                    <button id="btn-confirmar-reserva" class="w-full py-3 px-4 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-300 shadow-lg text-lg">
                        Confirmar Reserva (Horario: <span id="horario-seleccionado-display">--:--</span>)
                    </button>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-gray-900 text-gray-400 border-t border-gray-800 py-12 mt-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8 text-sm">
            
            <div>
                <h3 class="text-xl font-bold text-gray-100 mb-4">Complejo Deportivo</h3>
                <p class="mb-4">Tu plataforma #1 para reservar canchas de fútbol. Calidad, comodidad y pasión por el deporte.</p>
                <div class="flex space-x-4 mt-6">
                    <a href="#" class="text-gray-400 hover:text-emerald-500 transition-colors duration-200"><svg class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.776-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33V22C17.657 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg></a>
                    <a href="#" class="text-gray-400 hover:text-emerald-500 transition-colors duration-200"><svg class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.002 3.714.051 1.104.122 1.633.275 2.05.432.58.236.966.52 1.32.885.363.363.647.75.886 1.32.158.417.31.946.433 2.05.049.93.051 1.286.051 3.715s-.002 2.784-.051 3.714c-.122 1.104-.275 1.633-.432 2.05-.236.58-.52 0-.885 1.32-.363.363-.75.647-1.32.886-.417.158-.946.31-2.05.433-.93.049-1.286.051-3.715.051s-2.784-.002-3.714-.051c-1.104-.122-1.633-.275-2.05-.432-.58-.236-.966.52-1.32-.885-.363.363-.647-.75-.886-1.32-.158-.417-.31-.946.433 2.05-.049-.93-.051-1.286-.051-3.715s.002-2.784.051-3.714c.122-1.104.275-1.633.432 2.05.236-.58.52-.966.885-1.32.363.363.75-.647 1.32-.886.417-.158.946-.31 2.05-.433.93-.049 1.286.051 3.715-.051zM12 4.419c-2.86 0-3.25.01-4.38.06-1.07.124-1.61.277-1.95.408-.43.167-.704.37-1.002.668-.298.298-.5.572-.667 1.002-.13.34-.284.88-.408 1.95-.05.93-.06 1.32-.06 4.38s.01 3.25.06 4.38c.124 1.07.277 1.61.408 1.95.167.43.37.704.668 1.002.298.298.572.5.952.667.34.13 1.01.284 1.94.408 1.13.05 4.09.06 4.38.06s3.25-.01 4.38-.06c1.07-.124 1.61-.277 1.95-.408.43-.167.704-.37 1.002-.668.298-.298-.5-.572-.667 1.002.13-.34.284-.88.408-1.95.05-.93.06-1.32.06-4.38s-.01-3.25-.06-4.38c-.124-1.07-.277-1.61-.408-1.95-.167-.43-.37-.704-.668-1.002-.298-.298-.572-.5-.952-.667-.34-.13-1.01-.284-1.94-.408-.05-.93-.06-1.32-.06-4.38zm-1.82 7.78a3.61 3.61 0 100-7.22 3.61 3.61 0 000 7.22zM12 6.8c-2.09 0-3.8 1.71-3.8 3.8s1.71 3.8 3.8 3.8 3.8-1.71 3.8-3.8-1.71-3.8-3.8-3.8z" clip-rule="evenodd" /></svg></a>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-100 mb-4">Navegación Rápida</h3>
                <ul class="space-y-3">
                    <li><a href="index.html" class="hover:text-emerald-500 transition-colors duration-200">Inicio</a></li>
                    <li><a href="reservar.html" class="hover:text-emerald-500 transition-colors duration-200">Reservar Ahora</a></li>
                    <li><a href="perfil.html" class="hover:text-emerald-500 transition-colors duration-200">Mi Perfil</a></li>
                    <li><a href="#" class="hover:text-emerald-500 transition-colors duration-200">Preguntas Frecuentes</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-100 mb-4">Contáctanos</h3>
                <p class="mb-2">Email: <a href="mailto:info@complejodeportivo.com" class="hover:text-emerald-500 transition-colors duration-200">info@complejodeportivo.com</a></p>
                <p>Teléfono: <a href="tel:+541155551234" class="hover:text-emerald-500 transition-colors duration-200">+54 11 5555-1234</a></p>
                <p class="mt-4">Dirección: Av. Siempre Viva 742, Buenos Aires, Argentina</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-100 mb-4">Información Legal</h3>
                <ul class="space-y-3">
                    <li><a href="#" class="hover:text-emerald-500 transition-colors duration-200">Términos y Condiciones</a></li>
                    <li><a href="#" class="hover:text-emerald-500 transition-colors duration-200">Política de Privacidad</a></li>
                    <li><a href="#" class="hover:text-emerald-500 transition-colors duration-200">Mapa del Sitio</a></li>
                </ul>
            </div>
        </div>
        <div class="border-t border-gray-800 mt-12 pt-8 text-center text-gray-500">
            <p>&copy; 2025 Complejo Deportivo. Todos los derechos reservados.</p>
        </div>
    </footer>

    <div id="modal-alerta" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70">
        <div class="modal-content bg-gray-900 rounded-lg shadow-xl w-full max-w-md p-6 border border-gray-700">
            
            <div id="alerta-exito" class="hidden text-center">
                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-emerald-900 text-emerald-400 mx-auto">
                   <svg class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h3 class="text-lg font-medium leading-6 text-white mt-4" id="modal-alerta-titulo">¡Reserva Confirmada!</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-400" id="modal-alerta-mensaje">Tu reserva se ha completado con éxito.</p>
                </div>
                <a href="index.html" class="mt-6 w-full inline-block py-3 px-4 bg-emerald-600 text-white rounded-md font-semibold hover:bg-emerald-700 transition-colors duration-300 shadow-lg">
                    Volver al Inicio
                </a>
            </div>

            <div id="alerta-error" class="hidden text-center">
                 <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-900 text-red-400 mx-auto">
                   <svg class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </div>
                <h3 class="text-lg font-medium leading-6 text-white mt-4" id="modal-error-titulo">Error en la Reserva</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-400" id="modal-error-mensaje">No pudimos procesar tu reserva.</p>
                </div>
                 <button type="button" id="btn-alerta-ok" class="mt-6 w-full inline-flex justify-center rounded-md border border-transparent bg-emerald-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-emerald-700 sm:text-sm">
                    Entendido
                </button>
            </div>

        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // ... (código JS sin cambios) ...
        try {
            protegerPagina(['Cliente']);
        } catch (e) {
            console.error(e.message);
            throw new Error("Redireccionando al login...");
        }

        let reservaState = {};
        const selectComplejo = document.getElementById('reserva-complejo');
        const selectFecha = document.getElementById('reserva-fecha');
        const selectCancha = document.getElementById('reserva-cancha');
        const loaderHorarios = document.getElementById('reserva-horarios-loader');
        const gridHorarios = document.getElementById('reserva-horarios-grid');
        const placeholderHorarios = document.getElementById('horarios-placeholder');
        const pasoFinal = document.getElementById('paso-final');
        const pasoFinalError = document.getElementById('paso-final-error');
        const btnConfirmar = document.getElementById('btn-confirmar-reserva');
        const displayHorarioSeleccionado = document.getElementById('horario-seleccionado-display');
        const modalAlerta = document.getElementById('modal-alerta');
        const modalAlertaExito = document.getElementById('alerta-exito');
        const modalAlertaError = document.getElementById('alerta-error');
        const modalAlertaTitulo = document.getElementById('modal-alerta-titulo');
        const modalAlertaMensaje = document.getElementById('modal-alerta-mensaje');
        const modalErrorTitulo = document.getElementById('modal-error-titulo');
        const modalErrorMensaje = document.getElementById('modal-error-mensaje');
        const btnAlertaOk = document.getElementById('btn-alerta-ok');

        async function cargarComplejos() {
            try {
                const complejos = await apiFetch('/reserva/complejos', {}, false); 
                selectComplejo.innerHTML = '<option value="">Seleccioná un complejo</option>';
                complejos.forEach(c => {
                    selectComplejo.innerHTML += `<option value="${c.complejoId}">${c.nombre}</option>`;
                });
            } catch (error) {
                selectComplejo.innerHTML = `<option value="">Error al cargar</option>`;
                console.error(error);
            }
        }

        async function cargarCanchas(complejoId) {
            if (!complejoId) {
                selectCancha.innerHTML = '<option value="">Elegí un complejo primero</option>';
                selectCancha.disabled = true;
                return;
            }
            
            selectCancha.innerHTML = '<option value="">Buscando canchas...</option>';
            selectCancha.disabled = true;
            
            try {
                const canchas = await apiFetch(`/reserva/canchas/${complejoId}`, {}, false);
                
                if(canchas.length === 0) {
                     selectCancha.innerHTML = '<option value="">No hay canchas disponibles</option>';
                     return;
                }

                selectCancha.innerHTML = '<option value="">Seleccioná una cancha</option>';
                canchas.forEach(c => {
                    selectCancha.innerHTML += `<option value="${c.canchaId}">${c.nombre}</option>`;
                });
                selectCancha.disabled = false;
            } catch (error) {
                selectCancha.innerHTML = `<option value="">Error al cargar canchas</option>`;
                console.error(error);
            }
        }
        
        async function cargarHorarios() {
            const canchaId = selectCancha.value;
            const fecha = selectFecha.value;

            gridHorarios.innerHTML = '';
            gridHorarios.classList.add('hidden');
            pasoFinal.classList.add('hidden');
            reservaState = {};

            if (!canchaId || !fecha) {
                placeholderHorarios.classList.remove('hidden');
                loaderHorarios.classList.add('hidden');
                return;
            }

            placeholderHorarios.classList.add('hidden');
            loaderHorarios.classList.remove('hidden');

            try {
                const horarios = await apiFetch(`/reserva/disponibilidad?canchaId=${canchaId}&fecha=${fecha}`, {}, false);
                loaderHorarios.classList.add('hidden');

                if (horarios.length === 0) {
                    gridHorarios.innerHTML = '<p class="text-gray-400 col-span-full text-center">No hay horarios disponibles para esta cancha en la fecha seleccionada.</p>';
                } else {
                    horarios.forEach(horario => {
                        const horaInicioSimple = horario.horaInicio.substring(0, 5); 
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'horario-btn p-2 border border-gray-700 rounded-md text-sm font-semibold hover:border-emerald-500 text-gray-200 transition-all duration-200';
                        button.textContent = horaInicioSimple;
                        button.dataset.inicio = horario.horaInicio;
                        button.dataset.fin = horario.horaFin;
                        gridHorarios.appendChild(button);
                    });
                }
                gridHorarios.classList.remove('hidden');

            } catch (error) {
                loaderHorarios.classList.add('hidden');
                gridHorarios.innerHTML = `<p class="text-red-500 col-span-full text-center">Error al cargar horarios: ${error.message}</p>`;
                gridHorarios.classList.remove('hidden');
                console.error(error);
            }
        }

        function handleSeleccionHorario(event) {
            const target = event.target;
            if (target.tagName !== 'BUTTON' || !target.classList.contains('horario-btn')) {
                return;
            }
            
            document.querySelectorAll('.horario-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            target.classList.add('selected');
            
            reservaState = {
                canchaId: selectCancha.value,
                fecha: selectFecha.value,
                horaInicio: target.dataset.inicio,
                horaFin: target.dataset.fin
            };
            
            displayHorarioSeleccionado.textContent = target.textContent;
            pasoFinalError.classList.add('hidden');
            pasoFinal.classList.remove('hidden');
        }

        async function crearReserva() {
            const clienteId = AuthService.getUserData().clienteId;

            if (!reservaState.horaInicio) {
                pasoFinalError.textContent = 'Por favor, seleccioná un horario antes de confirmar.';
                pasoFinalError.classList.remove('hidden');
                return;
            }
            pasoFinalError.classList.add('hidden');
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = 'Procesando...';

            const crearReservaDto = {
                clienteId: parseInt(clienteId),
                canchaIds: [ parseInt(reservaState.canchaId) ],
                fecha: reservaState.fecha,
                horaInicio: reservaState.horaInicio,
                horaFin: reservaState.horaFin,
                ambito: "Web"
            };

            try {
                await apiFetch('/reserva', {
                    method: 'POST',
                    body: JSON.stringify(crearReservaDto)
                });
                
                modalAlertaExito.classList.remove('hidden');
                modalAlertaError.classList.add('hidden');
                modalAlerta.classList.remove('hidden');
                
                document.querySelector('main').innerHTML = ''; 

            } catch (error) {
                modalErrorMensaje.textContent = error.message;
                modalAlertaExito.classList.add('hidden');
                modalAlertaError.classList.remove('hidden');
                modalAlerta.classList.remove('hidden');
                
                console.error("Error al crear reserva:", error);
                
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = 'Confirmar Reserva (Horario: <span id="horario-seleccionado-display">--:--</span>)';
                document.getElementById('horario-seleccionado-display').textContent = reservaState.horaInicio.substring(0,5);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            selectFecha.min = hoy;
            selectFecha.value = hoy;
            
            cargarComplejos();
            
            selectComplejo.addEventListener('change', (e) => {
                cargarCanchas(e.target.value);
                cargarHorarios();
            });
            selectFecha.addEventListener('change', cargarHorarios);
            selectCancha.addEventListener('change', cargarHorarios);
            
            gridHorarios.addEventListener('click', handleSeleccionHorario);
            btnConfirmar.addEventListener('click', crearReserva);
            btnAlertaOk.addEventListener('click', () => modalAlerta.classList.add('hidden'));
        });
    </script>

</body>
</html>