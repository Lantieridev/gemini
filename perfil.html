<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Complejo Deportivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-bottom-color: #3B82F6; /* blue-500 */
            color: #3B82F6; /* blue-500 */
            font-weight: 600;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold text-blue-600">Complejo</span>
                    <span class="text-2xl font-bold text-gray-700">Deportivo</span>
                </a>
                <div>
                     <a href="index.html" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                        &larr; Volver al inicio
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Mi Perfil</h1>
        <p class="text-lg text-gray-600 mb-6">Hola, <span id="user-email" class="font-medium">...</span></p>

        <div>
            <div class="border-b border-gray-300">
                <nav class="-mb-px flex space-x-6" role="tablist">
                    <button role="tab" aria-selected="true" id="tab-proximas" class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Próximas Reservas
                    </button>
                    <button role="tab" aria-selected="false" id="tab-historial" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Historial de Reservas
                    </button>
                    <button role="tab" aria-selected="false" id="tab-datos" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Mis Datos
                    </button>
                </nav>
            </div>

            <div class="mt-6">
                <div role="tabpanel" id="panel-proximas">
                    <div id="loader-proximas" class="text-center p-8">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                        <p class="mt-2 text-gray-600">Cargando próximas reservas...</p>
                    </div>
                    <div id="lista-proximas" class="space-y-4">
                        </div>
                </div>

                <div role="tabpanel" id="panel-historial" class="hidden">
                    <div id="loader-historial" class="text-center p-8">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                        <p class="mt-2 text-gray-600">Cargando historial...</p>
                    </div>
                    <div id="lista-historial" class="space-y-4">
                        </div>
                </div>

                <div role="tabpanel" id="panel-datos" class="hidden">
                    <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow">
                        
                        <div id="loader-perfil" class="text-center p-8">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div>
                            <p class="mt-2 text-gray-600">Cargando tus datos...</p>
                        </div>
                        
                        <form id="form-perfil" class="hidden">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email (Usuario)</label>
                                    <input type="email" id="perfil-email" readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm">
                                </div>
                                <div>
                                    <label for="perfil-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                                    <input type="text" id="perfil-nombre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="perfil-apellido" class="block text-sm font-medium text-gray-700">Apellido</label>
                                    <input type="text" id="perfil-apellido" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="perfil-telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                    <input type="tel" id="perfil-telefono" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="perfil-documento" class="block text-sm font-medium text-gray-700">Documento</label>
                                    <input type="text" id="perfil-documento" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <button type="submit" id="btn-guardar-perfil" class="w-full rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                    Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-400 mt-auto">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p>&copy; 2025 Complejo Deportivo. Todos los derechos reservados.</p>
        </div>
    </footer>

    <div id="modal-confirmacion" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100">
                <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="mt-3 text-center sm:mt-5">
                <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-confirm-titulo">Confirmar Acción</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" id="modal-confirm-mensaje">¿Estás seguro?</p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button type="button" id="btn-confirmar" class="inline-flex w-full justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-red-700 sm:col-start-2 sm:text-sm">
                    Confirmar
                </button>
                <button type="button" id="btn-cancelar" class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 sm:col-start-1 sm:mt-0 sm:text-sm">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-alerta" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="text-center">
                <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-alerta-titulo">Éxito</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" id="modal-alerta-mensaje">Operación completada.</p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6">
                <button type="button" id="btn-alerta-ok" class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 sm:text-sm">
                    Entendido
                </button>
            </div>
        </div>
    </div>


    <script src="auth.js"></script>
    <script>
        // --- 1. PROTEGER LA PÁGINA ---
        try {
            protegerPagina(['Cliente']);
        } catch (e) {
            console.error(e.message);
            throw new Error("Redireccionando al login...");
        }

        // --- 2. LÓGICA DE LA PÁGINA ---
        const { clienteId, email } = AuthService.getUserData();

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos del usuario y reservas
            document.getElementById('user-email').textContent = email;
            document.getElementById('perfil-email').value = email;
            
            cargarReservas();
            cargarDatosPerfil(); // Cargar datos del formulario
            
            // Configurar Pestañas
            const tabs = document.querySelectorAll('.tab-button');
            const panels = document.querySelectorAll('[role="tabpanel"]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    panels.forEach(p => p.classList.add('hidden'));
                    tab.classList.add('active');
                    document.getElementById(tab.id.replace('tab-', 'panel-')).classList.remove('hidden');
                });
            });

            // Configurar Modales
            document.getElementById('btn-cancelar').addEventListener('click', () => document.getElementById('modal-confirmacion').classList.add('hidden'));
            document.getElementById('btn-alerta-ok').addEventListener('click', () => document.getElementById('modal-alerta').classList.add('hidden'));

            // Listener para botones de cancelar (delegación de eventos)
            document.getElementById('lista-proximas').addEventListener('click', (event) => {
                const cancelButton = event.target.closest('.btn-cancelar');
                if (cancelButton) {
                    const reservaId = cancelButton.dataset.reservaId;
                    handleCancelarClick(reservaId);
                }
            });

            // Listener para el formulario de perfil
            document.getElementById('form-perfil').addEventListener('submit', handleGuardarPerfil);
        });

        /**
         * Carga todas las reservas del cliente y las clasifica.
         */
        async function cargarReservas() {
            mostrarLoader('proximas', true);
            mostrarLoader('historial', true);

            try {
                const todasLasReservas = await apiFetch(`/reserva/cliente/${clienteId}`);
                
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0); 

                const proximas = [];
                const pasadas = [];

                todasLasReservas.forEach(reserva => {
                    const fechaReserva = new Date(`${reserva.fecha}T${reserva.horaInicio}`);
                    
                    if (fechaReserva >= hoy) {
                        proximas.push(reserva);
                    } else {
                        pasadas.push(reserva);
                    }
                });

                proximas.sort((a, b) => new Date(`${a.fecha}T${a.horaInicio}`) - new Date(`${b.fecha}T${b.horaInicio}`));
                pasadas.sort((a, b) => new Date(`${b.fecha}T${b.horaInicio}`) - new Date(`${a.fecha}T${a.horaInicio}`));

                renderReservas(proximas, 'lista-proximas');
                renderReservas(pasadas, 'lista-historial');

            } catch (error) {
                console.error("Error al cargar reservas:", error);
                document.getElementById('lista-proximas').innerHTML = `<p class="text-red-600">Error al cargar reservas: ${error.message}</p>`;
            } finally {
                mostrarLoader('proximas', false);
                mostrarLoader('historial', false);
            }
        }

        /**
         * Muestra u oculta el spinner de carga.
         */
        function mostrarLoader(seccion, mostrar) {
            const loader = document.getElementById(`loader-${seccion}`);
            const lista = document.getElementById(`lista-${seccion}`);
            if (loader) loader.classList.toggle('hidden', !mostrar);
            if (lista) lista.classList.toggle('hidden', mostrar);
        }

        /**
         * Dibuja las tarjetas de reserva en el HTML.
         */
        function renderReservas(reservas, elementoId) {
            const contenedor = document.getElementById(elementoId);
            contenedor.innerHTML = ''; // Limpiar

            if (reservas.length === 0) {
                contenedor.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-gray-500">
                    <p>No tienes reservas en esta categoría.</p>
                </div>`;
                return;
            }

            reservas.forEach(reserva => {
                const canchaNombre = reserva.detalles.map(d => d.nombreCancha).join(', ') || 'Cancha no especificada';
                const fecha = new Date(`${reserva.fecha}T00:00:00`).toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const horaInicio = reserva.horaInicio.substring(0, 5);
                const horaFin = reserva.horaFin.substring(0, 5);
                
                const esCancelable = (reserva.estado.toLowerCase() === 'confirmada' || reserva.estado.toLowerCase() === 'pendiente') && elementoId === 'lista-proximas';
                const estadoColor = getEstadoColor(reserva.estado);

                const cardHTML = `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-5">
                        <div class="flex flex-col sm:flex-row justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">${canchaNombre}</h3>
                                <p class="text-md text-gray-600 capitalize">${fecha}</p>
                                <p class="text-md text-gray-600">${horaInicio} a ${horaFin} hs</p>
                            </div>
                            <div class="mt-4 sm:mt-0 sm:text-right">
                                <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium ${estadoColor}">
                                    ${reserva.estado}
                                </span>
                                <p class="text-2xl font-bold text-gray-900 mt-1">$${reserva.total.toLocaleString('es-AR')}</p>
                            </div>
                        </div>
                        ${esCancelable ? `
                        <div class="mt-4 pt-4 border-t border-gray-200 text-right">
                            <button class="btn-cancelar inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50"
                                    data-reserva-id="${reserva.reservaId}">
                                <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Cancelar Reserva
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
                contenedor.innerHTML += cardHTML;
            });
        }

        function getEstadoColor(estado) {
            switch (estado.toLowerCase()) {
                case 'confirmada':
                    return 'bg-green-100 text-green-800';
                case 'cancelada':
                    return 'bg-red-100 text-red-800';
                case 'pendiente':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        /**
         * Muestra el modal de confirmación para cancelar.
         */
        function handleCancelarClick(reservaId) {
            abrirModalConfirmacion(
                'Cancelar Reserva',
                '¿Estás seguro de que deseas cancelar esta reserva? Esta acción no se puede deshacer.',
                () => { // Esta es la función de callback
                    cancelarReserva(reservaId);
                }
            );
        }

        /**
         * Llama a la API para cancelar la reserva.
         */
        async function cancelarReserva(reservaId) {
            const dto = {
                reservaId: parseInt(reservaId),
                clienteId: parseInt(clienteId),
                motivo: "Cancelación desde perfil de cliente."
            };

            try {
                await apiFetch('/reserva/cancelar', {
                    method: 'PUT',
                    body: JSON.stringify(dto)
                });
                
                abrirModalAlerta('Reserva Cancelada', 'Tu reserva ha sido cancelada exitosamente.');
                cargarReservas(); // Recargar la lista

            } catch (error) {
                console.error('Error al cancelar:', error);
                abrirModalAlerta('Error al Cancelar', error.message);
            }
        }

        // --- FUNCIONES DE PERFIL (NUEVAS) ---

        /**
         * Carga los datos del cliente en el formulario "Mis Datos".
         */
        async function cargarDatosPerfil() {
            document.getElementById('loader-perfil').classList.remove('hidden');
            document.getElementById('form-perfil').classList.add('hidden');
            
            try {
                // Gracias a los cambios en ClienteController, esto ahora funciona
                const clienteData = await apiFetch(`/api/admin/clientes/${clienteId}`);
                
                document.getElementById('perfil-nombre').value = clienteData.nombre;
                document.getElementById('perfil-apellido').value = clienteData.apellido;
                document.getElementById('perfil-telefono').value = clienteData.telefono || '';
                document.getElementById('perfil-documento').value = clienteData.documento || '';

                document.getElementById('form-perfil').classList.remove('hidden');
                
            } catch (error) {
                console.error("Error al cargar datos del perfil:", error);
                abrirModalAlerta("Error", "No se pudieron cargar tus datos de perfil.");
            } finally {
                document.getElementById('loader-perfil').classList.add('hidden');
            }
        }

        /**
         * Maneja el envío del formulario de "Mis Datos".
         */
        async function handleGuardarPerfil(event) {
            event.preventDefault();
            const boton = document.getElementById('btn-guardar-perfil');
            boton.textContent = 'Guardando...';
            boton.disabled = true;

            const dto = {
                nombre: document.getElementById('perfil-nombre').value,
                apellido: document.getElementById('perfil-apellido').value,
                telefono: document.getElementById('perfil-telefono').value,
                documento: document.getElementById('perfil-documento').value,
                email: document.getElementById('perfil-email').value // El DTO lo requiere
            };

            try {
                // La API ahora permite a los clientes hacer PUT en su propio ID
                await apiFetch(`/api/admin/clientes/${clienteId}`, {
                    method: 'PUT',
                    body: JSON.stringify(dto)
                });
                
                abrirModalAlerta('Perfil Actualizado', 'Tus datos han sido guardados exitosamente.');

            } catch (error) {
                console.error('Error al guardar perfil:', error);
                abrirModalAlerta('Error', `No se pudo guardar tu perfil: ${error.message}`);
            } finally {
                boton.textContent = 'Guardar Cambios';
                boton.disabled = false;
            }
        }

        // --- Funciones de Modales (Genéricas) ---
        function abrirModalConfirmacion(titulo, mensaje, onConfirmCallback) {
            const modal = document.getElementById('modal-confirmacion');
            document.getElementById('modal-confirm-titulo').textContent = titulo;
            document.getElementById('modal-confirm-mensaje').textContent = mensaje;
            
            const btnConfirmar = document.getElementById('btn-confirmar');
            const btnNuevo = btnConfirmar.cloneNode(true); // Clonar para limpiar listeners
            btnConfirmar.parentNode.replaceChild(btnNuevo, btnConfirmar);
            
            btnNuevo.addEventListener('click', () => {
                modal.classList.add('hidden');
                if (onConfirmCallback) {
                    onConfirmCallback();
                }
            }, { once: true }); // El listener se ejecuta una sola vez
            
            modal.classList.remove('hidden');
        }

        function abrirModalAlerta(titulo, mensaje) {
            const modal = document.getElementById('modal-alerta');
            document.getElementById('modal-alerta-titulo').textContent = titulo;
            document.getElementById('modal-alerta-mensaje').textContent = mensaje;
            modal.classList.remove('hidden');
        }

    </script>

</body>
</html>